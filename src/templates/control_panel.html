<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Panel - Nh·∫≠n Di·ªán Khu√¥n M·∫∑t & ƒêi·ªÅu Khi·ªÉn C·ª≠a</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        #video {
            width: 100%;
            display: block;
        }

        #canvas {
            display: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .doorbell-panel {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .doorbell-panel .input-group {
            flex: 1;
            min-width: 200px;
        }

        .doorbell-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .doorbell-gallery img {
            width: 110px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .doorbell-history {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-box {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            min-height: 100px;
        }

        .result-success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .result-error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .result-info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
        }

        .result-box h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .result-box p {
            margin: 5px 0;
            font-size: 1.1em;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #28a745;
            box-shadow: 0 0 10px #28a745;
        }

        .status-offline {
            background: #dc3545;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .upload-area:hover {
            background: #f0f0f0;
            border-color: #5568d3;
        }

        .upload-area.dragover {
            background: #e7f3ff;
            border-color: #28a745;
        }

        #fileInput {
            display: none;
        }

        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }

        .log-entry.error {
            color: #ff6b6b;
        }

        .log-entry.success {
            color: #51cf66;
        }

        .log-entry.info {
            color: #74c0fc;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .status-text {
            margin-top: 10px;
            font-size: 0.95em;
            color: #555;
        }

        .input-group {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-weight: 600;
            color: #444;
        }

        .input-group input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
        }

        .person-list-container {
            margin-top: 20px;
        }

        .person-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            background: white;
        }

        .person-list li {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }

        .person-list li:last-child {
            border-bottom: none;
        }

        .person-count {
            color: #667eea;
            font-weight: 600;
        }

        .nav-tabs {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-tabs a {
            text-decoration: none;
            padding: 10px 18px;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-tabs a:hover {
            background: rgba(255,255,255,0.35);
        }

        .nav-tabs a.active {
            background: white;
            color: #764ba2;
        }

        .hidden-section {
            display: none !important;
        }

    </style>
</head>
<body data-page="{{ page_mode or 'capture' }}">
    {% set mode = page_mode or 'capture' %}
    <div class="container">
        <div class="header">
            <h1>üéØ Control Panel</h1>
            <p>Nh·∫≠n Di·ªán Khu√¥n M·∫∑t & ƒêi·ªÅu Khi·ªÉn C·ª≠a T·ª± ƒê·ªông</p>
            <p style="margin-top: 10px;">
                <span class="status-indicator" id="serverStatus"></span>
                <span id="serverStatusText">ƒêang ki·ªÉm tra...</span>
            </p>
            <div class="nav-tabs">
                <a href="/capture" data-nav="capture" class="{{ 'active' if mode == 'capture' else '' }}">üìö Thu th·∫≠p d·ªØ li·ªáu</a>
                <a href="/auto-door" data-nav="auto" class="{{ 'active' if mode == 'auto' else '' }}">ü§ñ M·ªü c·ª≠a t·ª± ƒë·ªông</a>
                <a href="/manual-control" data-nav="manual" class="{{ 'active' if mode == 'manual' else '' }}">üïπÔ∏è ƒêi·ªÅu khi·ªÉn th·ªß c√¥ng</a>
            </div>
        </div>

        <div class="content">
            <!-- Section 1: Camera & Capture -->
            {% if mode in ['capture', 'auto'] %}
            <div class="section">
                <h2>üì∏ 1. Ch·ª•p ·∫¢nh Khu√¥n M·∫∑t</h2>
                <div class="camera-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" id="startCamera">B·∫≠t Camera</button>
                    <button class="btn btn-success" id="captureBtn" disabled>Ch·ª•p ·∫¢nh</button>
                    <button class="btn btn-danger" id="stopCamera" disabled>T·∫Øt Camera</button>
                </div>
                <div class="upload-area" id="uploadArea">
                    <p>üìÅ Ho·∫∑c k√©o th·∫£ ·∫£nh v√†o ƒë√¢y ƒë·ªÉ upload</p>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">Click ƒë·ªÉ ch·ªçn file</p>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                {% if mode == 'capture' %}
                <div class="input-group">
                    <label for="autoCaptureCount">S·ªë ·∫£nh mu·ªën ch·ª•p t·ª± ƒë·ªông</label>
                    <input type="number" id="autoCaptureCount" value="100" min="10" max="500">
                </div>
                <div class="controls">
                    <button class="btn btn-primary" id="autoCaptureBtn">T·ª± ƒë·ªông ch·ª•p & l∆∞u</button>
                    <button class="btn btn-danger" id="stopAutoCaptureBtn" disabled>D·ª´ng ch·ª•p</button>
                </div>
                <p class="status-text" id="autoCaptureStatus">Ch∆∞a b·∫Øt ƒë·∫ßu ch·ª•p t·ª± ƒë·ªông.</p>
                {% endif %}

                {% if mode == 'auto' %}
                <div>
                    <hr style="margin:25px 0;">
                    <h3>üõéÔ∏è Chu√¥ng c·ª≠a & x·ª≠ l√Ω AI</h3>
                    <div class="doorbell-panel">
                        <div class="input-group">
                            <label for="doorbellShots">S·ªë ·∫£nh ch·ª•p khi kh√°ch b·∫•m chu√¥ng (5-10)</label>
                            <input type="number" id="doorbellShots" value="6" min="3" max="10">
                        </div>
                        <button class="btn btn-success" id="doorbellBtn" disabled>Gi·∫£ l·∫≠p b·∫•m chu√¥ng</button>
                        <button class="btn btn-warning" id="adminOpenFromCam">Admin m·ªü c·ª≠a th·ªß c√¥ng</button>
                    </div>
                    <p class="status-text" id="doorbellStatus">Ch∆∞a c√≥ s·ª± ki·ªán chu√¥ng c·ª≠a.</p>
                    <div id="doorbellGallery" class="doorbell-gallery"></div>
                    <div class="doorbell-history">
                        <h3>K·∫øt qu·∫£ nh·∫≠n di·ªán m·ªõi nh·∫•t</h3>
                        <div id="doorbellResult">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% endif %}

            <!-- Section 2: Recognition -->
            {% if mode == 'capture' %}
            <div class="section">
                <h2>üîç 2. Nh·∫≠n Di·ªán Khu√¥n M·∫∑t</h2>
                <div class="controls">
                    <button class="btn btn-primary" id="recognizeBtn" disabled>Nh·∫≠n Di·ªán</button>
                    <button class="btn btn-warning" id="clearResult">X√≥a K·∫øt Qu·∫£</button>
                </div>
                <div id="resultBox" class="result-box" style="display: none;">
                    <h3 id="resultTitle"></h3>
                    <p id="resultName"></p>
                    <p id="resultProbability"></p>
                    <p id="resultMessage"></p>
                </div>
            </div>
            {% endif %}

            <!-- Section 3: Add Person -->
            {% if mode == 'capture' %}
            <div class="section">
                <h2>üë§ 3. Th√™m Ng∆∞·ªùi D√πng M·ªõi</h2>
                <div class="input-group">
                    <label for="personName">T√™n ng∆∞·ªùi (kh√¥ng d·∫•u, v√≠ d·ª•: tan, tan2, minh)</label>
                    <input type="text" id="personName" placeholder="nh·∫≠p t√™n ng∆∞·ªùi m·ªõi...">
                </div>
                <div class="controls">
                    <button class="btn btn-success" id="saveToDataset" disabled>L∆∞u ·∫¢nh V√†o Dataset</button>
                    <button class="btn btn-primary" id="alignPerson" disabled>Align ·∫£nh</button>
                    <button class="btn btn-primary" id="trainPerson" disabled>Train Ng∆∞·ªùi N√†y</button>
                    <button class="btn btn-warning" id="refreshPersons">L√†m M·ªõi Danh S√°ch</button>
                </div>
                <div class="person-list-container">
                    <h3>Danh s√°ch ng∆∞·ªùi ƒë√£ c√≥</h3>
                    <ul id="personList" class="person-list">
                        <li>ƒêang t·∫£i...</li>
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Section 4: Door Control -->
            {% if mode == 'manual' %}
            <div class="section">
                <h2>üö™ 4. ƒêi·ªÅu Khi·ªÉn C·ª≠a</h2>
                <div class="controls">
                    <button class="btn btn-success" id="openDoorBtn">M·ªü C·ª≠a</button>
                    <button class="btn btn-danger" id="closeDoorBtn">ƒê√≥ng C·ª≠a</button>
                </div>
                <div class="stat-card" style="margin-top: 20px;">
                    <h3>Tr·∫°ng Th√°i C·ª≠a</h3>
                    <div class="stat-value" id="doorStatus">Ch∆∞a x√°c ƒë·ªãnh</div>
                </div>
            </div>
            {% endif %}

            <!-- Section 5: Statistics -->
            {% if mode == 'manual' %}
            <div class="section">
                <h2>üìä 5. Th·ªëng K√™</h2>
                <div class="grid">
                    <div class="stat-card">
                        <h3>T·ªïng L·∫ßn Nh·∫≠n Di·ªán</h3>
                        <div class="stat-value" id="totalRecognitions">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Th√†nh C√¥ng</h3>
                        <div class="stat-value" id="successCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Th·∫•t B·∫°i</h3>
                        <div class="stat-value" id="failCount">0</div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Section 6: Log -->
            {% if mode == 'manual' %}
            <div class="section">
                <h2>üìù 6. Log Ho·∫°t ƒê·ªông</h2>
                <div class="log-container" id="logContainer"></div>
                <button class="btn btn-warning" id="clearLog" style="margin-top: 10px;">X√≥a Log</button>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const pageMode = document.body.dataset.page || 'capture';
        let stream = null;
        let capturedImage = null;
        let stats = { total: 0, success: 0, fail: 0 };

        const startCameraBtn = document.getElementById('startCamera');
        const stopCameraBtn = document.getElementById('stopCamera');
        const captureBtnEl = document.getElementById('captureBtn');
        const recognizeBtn = document.getElementById('recognizeBtn');
        const clearResultBtn = document.getElementById('clearResult');
        const openDoorBtn = document.getElementById('openDoorBtn');
        const closeDoorBtn = document.getElementById('closeDoorBtn');
        const personNameInput = document.getElementById('personName');
        const saveToDatasetBtn = document.getElementById('saveToDataset');
        const trainPersonBtn = document.getElementById('trainPerson');
        const alignPersonBtn = document.getElementById('alignPerson');
        const refreshPersonsBtn = document.getElementById('refreshPersons');
        const personListEl = document.getElementById('personList');
        const autoCaptureInput = document.getElementById('autoCaptureCount');
        const autoCaptureBtn = document.getElementById('autoCaptureBtn');
        const stopAutoCaptureBtn = document.getElementById('stopAutoCaptureBtn');
        const autoCaptureStatus = document.getElementById('autoCaptureStatus');
        const doorbellBtn = document.getElementById('doorbellBtn');
        const doorbellShotsInput = document.getElementById('doorbellShots');
        const doorbellStatus = document.getElementById('doorbellStatus');
        const doorbellGallery = document.getElementById('doorbellGallery');
        const doorbellResult = document.getElementById('doorbellResult');
        const adminOpenFromCam = document.getElementById('adminOpenFromCam');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const clearLogBtn = document.getElementById('clearLog');

        let autoCaptureState = { running: false, target: 100, count: 0 };

        // Initialize
        checkServerStatus();
        setInterval(checkServerStatus, 5000);
        if (personListEl) {
            loadPersons();
            setInterval(loadPersons, 20000);
        }
        updateAutoCaptureUI();

        if (pageMode === 'manual') {
            refreshManualPanels();
            setInterval(refreshManualPanels, 5000);
        }

        // Camera controls
        startCameraBtn && startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn && stopCameraBtn.addEventListener('click', stopCamera);
        captureBtnEl && captureBtnEl.addEventListener('click', captureImage);
        recognizeBtn && recognizeBtn.addEventListener('click', recognizeFace);
        clearResultBtn && clearResultBtn.addEventListener('click', clearResult);

        // Door controls
        openDoorBtn && openDoorBtn.addEventListener('click', () => controlDoor('OPEN', openDoorBtn));
        closeDoorBtn && closeDoorBtn.addEventListener('click', () => controlDoor('CLOSE', closeDoorBtn));

        // Person controls
        personNameInput && personNameInput.addEventListener('input', updateSaveButtonState);
        saveToDatasetBtn && saveToDatasetBtn.addEventListener('click', saveToDataset);
        alignPersonBtn && alignPersonBtn.addEventListener('click', alignPerson);
        trainPersonBtn && trainPersonBtn.addEventListener('click', trainPerson);
        refreshPersonsBtn && refreshPersonsBtn.addEventListener('click', loadPersons);
        autoCaptureBtn && autoCaptureBtn.addEventListener('click', startAutoCapture);
        stopAutoCaptureBtn && stopAutoCaptureBtn.addEventListener('click', stopAutoCapture);
        doorbellBtn && doorbellBtn.addEventListener('click', handleDoorbellEvent);
        adminOpenFromCam && adminOpenFromCam.addEventListener('click', () => controlDoor('OPEN', adminOpenFromCam));

        // File upload
        if (uploadArea && fileInput) {
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        clearLogBtn && clearLogBtn.addEventListener('click', clearLog);

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            if (!logContainer) {
                console.log(`[${timestamp}] ${message}`);
                return;
            }
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            const logContainer = document.getElementById('logContainer');
            fetch(`${API_BASE}/api/logs`, { method: 'DELETE' })
                .then(() => {
                    if (logContainer) {
                        logContainer.innerHTML = '';
                    }
                    loadLogsFromServer();
                })
                .catch(error => log(`Kh√¥ng th·ªÉ x√≥a log: ${error.message}`, 'error'));
        }

        function refreshManualPanels() {
            loadStatsFromServer();
            loadLogsFromServer();
        }

        function loadStatsFromServer() {
            fetch(`${API_BASE}/api/stats`)
                .then(response => response.json())
                .then(data => {
                    stats.total = data.total || 0;
                    stats.success = data.success || 0;
                    stats.fail = data.fail || 0;
                    updateStats();
                    if (data.door_status) {
                        updateDoorStatus(data.door_status);
                    }
                })
                .catch(error => log(`Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™: ${error.message}`, 'error'));
        }

        function loadLogsFromServer() {
            const logContainer = document.getElementById('logContainer');
            if (!logContainer) return;
            fetch(`${API_BASE}/api/logs`)
                .then(response => response.json())
                .then(data => {
                    logContainer.innerHTML = '';
                    const logs = data.logs || [];
                    if (!logs.length) {
                        const empty = document.createElement('div');
                        empty.className = 'log-entry info';
                        empty.textContent = 'Ch∆∞a c√≥ log n√†o.';
                        logContainer.appendChild(empty);
                        return;
                    }
                    logs.forEach(entry => {
                        const item = document.createElement('div');
                        const timeLabel = entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString() : '';
                        item.className = `log-entry ${entry.level || 'info'}`;
                        item.textContent = timeLabel ? `[${timeLabel}] ${entry.message}` : entry.message;
                        logContainer.appendChild(item);
                    });
                    logContainer.scrollTop = logContainer.scrollHeight;
                })
                .catch(error => log(`Kh√¥ng th·ªÉ t·∫£i log: ${error.message}`, 'error'));
        }

        function checkServerStatus() {
            fetch(`${API_BASE}/`)
                .then(response => {
                    if (response.ok) {
                        document.getElementById('serverStatus').className = 'status-indicator status-online';
                        document.getElementById('serverStatusText').textContent = 'Server ƒëang ho·∫°t ƒë·ªông';
                    } else {
                        throw new Error('Server kh√¥ng ph·∫£n h·ªìi');
                    }
                })
                .catch(error => {
                    document.getElementById('serverStatus').className = 'status-indicator status-offline';
                    document.getElementById('serverStatusText').textContent = 'Server kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c';
                });
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(mediaStream => {
                    stream = mediaStream;
                    const video = document.getElementById('video');
                    video.srcObject = stream;
                    if (startCameraBtn) startCameraBtn.disabled = true;
                    if (captureBtnEl) captureBtnEl.disabled = false;
                    if (stopCameraBtn) stopCameraBtn.disabled = false;
                    if (doorbellBtn) doorbellBtn.disabled = false;
                    log('Camera ƒë√£ ƒë∆∞·ª£c b·∫≠t', 'success');
                })
                .catch(error => {
                    log(`L·ªói khi b·∫≠t camera: ${error.message}`, 'error');
                    alert('Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p.');
                });
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                const video = document.getElementById('video');
                video.srcObject = null;
                if (startCameraBtn) startCameraBtn.disabled = false;
                if (captureBtnEl) captureBtnEl.disabled = true;
                if (stopCameraBtn) stopCameraBtn.disabled = true;
                if (doorbellBtn) doorbellBtn.disabled = true;
                log('Camera ƒë√£ ƒë∆∞·ª£c t·∫Øt', 'info');
            }
        }

        function captureImage() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            canvas.toBlob(blob => {
                capturedImage = blob;
                document.getElementById('recognizeBtn').disabled = false;
                log('ƒê√£ ch·ª•p ·∫£nh th√†nh c√¥ng', 'success');
                updateSaveButtonState();
            }, 'image/jpeg', 0.95);
        }

        function captureFrameBlob() {
            return new Promise((resolve, reject) => {
                if (!stream) {
                    reject(new Error('Camera ch∆∞a b·∫≠t'));
                    return;
                }
                const video = document.getElementById('video');
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    reject(new Error('Camera ch∆∞a s·∫µn s√†ng'));
                    return;
                }
                const canvas = document.getElementById('canvas');
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);
                canvas.toBlob(blob => {
                    if (blob) {
                        resolve(blob);
                    } else {
                        reject(new Error('Kh√¥ng th·ªÉ t·∫°o blob t·ª´ frame'));
                    }
                }, 'image/jpeg', 0.95);
            });
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Vui l√≤ng ch·ªçn file ·∫£nh!');
                return;
            }
            capturedImage = file;
            document.getElementById('recognizeBtn').disabled = false;
            log(`ƒê√£ ch·ªçn file: ${file.name}`, 'success');
            updateSaveButtonState();
        }

        async function handleDoorbellEvent() {
            if (!doorbellBtn || !doorbellShotsInput || !doorbellStatus || !doorbellGallery || !doorbellResult) {
                return;
            }
            if (!stream) {
                alert('Vui l√≤ng b·∫≠t camera tr∆∞·ªõc khi m√¥ ph·ªèng chu√¥ng c·ª≠a!');
                return;
            }
            const shots = Math.min(Math.max(parseInt(doorbellShotsInput.value, 10) || 6, 5), 10);
            doorbellBtn.disabled = true;
            doorbellBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
            doorbellStatus.textContent = `ƒêang ch·ª•p ${shots} ·∫£nh v√† g·ª≠i l√™n AI...`;
            doorbellGallery.innerHTML = '';
            doorbellResult.textContent = 'ƒêang ch·ªù k·∫øt qu·∫£...';
            const results = [];

            for (let i = 0; i < shots; i++) {
                try {
                    const blob = await captureFrameBlob();
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(blob);
                    doorbellGallery.appendChild(img);
                    const result = await recognizeBlob(blob);
                    results.push(result);
                    const msg = result && result.name && result.name !== 'Unknown'
                        ? `Frame ${i + 1}: ${result.name} (${((result.probability || 0) * 100).toFixed(1)}%)`
                        : `Frame ${i + 1}: Unknown`;
                    log(`[DOORBELL] ${msg}`, result && result.name !== 'Unknown' ? 'success' : 'info');
                    await sleep(250);
                } catch (error) {
                    log(`[DOORBELL] L·ªói frame ${i + 1}: ${error.message}`, 'error');
                }
            }

            const best = results
                .filter(r => r && !r.error)
                .sort((a, b) => (b.probability || 0) - (a.probability || 0))[0];

            if (best && best.name && best.name !== 'Unknown' && (best.probability || 0) > 0.8) {
                doorbellResult.textContent = `‚úÖ ƒê√£ nh·∫≠n di·ªán ${best.name} (${(best.probability * 100).toFixed(1)}%). MQTT ƒë√£ g·ª≠i l·ªánh m·ªü c·ª≠a.`;
                doorbellStatus.textContent = 'C·ª≠a ƒëang m·ªü cho kh√°ch ƒë∆∞·ª£c ph√©p.';
            } else {
                doorbellResult.textContent = '‚ö†Ô∏è Kh√¥ng kh·ªõp database. H·ªá th·ªëng gi·ªØ c·ª≠a ƒë√≥ng v√† l∆∞u ·∫£nh ƒë·ªÉ ki·ªÉm tra.';
                doorbellStatus.textContent = '·∫¢nh ƒë√£ ƒë∆∞·ª£c l∆∞u trong m·ª•c log tr√™n server.';
            }

            doorbellBtn.disabled = false;
            doorbellBtn.textContent = 'Gi·∫£ l·∫≠p b·∫•m chu√¥ng';
        }

        function recognizeBlob(blob) {
            const formData = new FormData();
            formData.append('file', blob);
            return fetch(`${API_BASE}/upload`, {
                method: 'POST',
                body: formData
            }).then(response => response.json());
        }

        function recognizeFace() {
            if (!capturedImage) {
                alert('Vui l√≤ng ch·ª•p ·∫£nh ho·∫∑c ch·ªçn file ·∫£nh tr∆∞·ªõc!');
                return;
            }

            const recognizeBtn = document.getElementById('recognizeBtn');
            recognizeBtn.disabled = true;
            recognizeBtn.textContent = 'ƒêang x·ª≠ l√Ω...';

            log('ƒêang g·ª≠i ·∫£nh l√™n server ƒë·ªÉ nh·∫≠n di·ªán...', 'info');

            const formData = new FormData();
            formData.append('file', capturedImage);

            fetch(`${API_BASE}/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                stats.total++;
                const resultBox = document.getElementById('resultBox');
                resultBox.style.display = 'block';

                if (data.error) {
                    resultBox.className = 'result-box result-error';
                    document.getElementById('resultTitle').textContent = '‚ùå L·ªói';
                    document.getElementById('resultName').textContent = '';
                    document.getElementById('resultProbability').textContent = '';
                    document.getElementById('resultMessage').textContent = data.error;
                    stats.fail++;
                    log(`L·ªói: ${data.error}`, 'error');
                } else if (data.name && data.name !== 'Unknown' && data.probability > 0.8) {
                    resultBox.className = 'result-box result-success';
                    document.getElementById('resultTitle').textContent = '‚úÖ Nh·∫≠n Di·ªán Th√†nh C√¥ng!';
                    document.getElementById('resultName').textContent = `üë§ T√™n: ${data.name}`;
                    document.getElementById('resultProbability').textContent = `üìä X√°c su·∫•t: ${(data.probability * 100).toFixed(2)}%`;
                    document.getElementById('resultMessage').textContent = `üéâ ${data.message} - C·ª≠a ƒë√£ ƒë∆∞·ª£c m·ªü t·ª± ƒë·ªông!`;
                    stats.success++;
                    log(`Nh·∫≠n di·ªán th√†nh c√¥ng: ${data.name} (${(data.probability * 100).toFixed(2)}%)`, 'success');
                    updateDoorStatus('M·ªü');
                } else {
                    resultBox.className = 'result-box result-info';
                    document.getElementById('resultTitle').textContent = '‚ùì Kh√¥ng Nh·∫≠n Di·ªán ƒê∆∞·ª£c';
                    document.getElementById('resultName').textContent = `üë§ T√™n: ${data.name || 'Unknown'}`;
                    document.getElementById('resultProbability').textContent = `üìä X√°c su·∫•t: ${(data.probability * 100).toFixed(2)}%`;
                    document.getElementById('resultMessage').textContent = `‚ö†Ô∏è ${data.message || 'Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c khu√¥n m·∫∑t'}`;
                    stats.fail++;
                    log(`Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c (x√°c su·∫•t: ${(data.probability * 100).toFixed(2)}%)`, 'error');
                }

                updateStats();
                if (recognizeBtn) {
                    recognizeBtn.disabled = false;
                    recognizeBtn.textContent = 'Nh·∫≠n Di·ªán';
                }
            })
            .catch(error => {
                stats.fail++;
                stats.total++;
                log(`L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
                const resultBox = document.getElementById('resultBox');
                resultBox.style.display = 'block';
                resultBox.className = 'result-box result-error';
                document.getElementById('resultTitle').textContent = '‚ùå L·ªói K·∫øt N·ªëi';
                document.getElementById('resultName').textContent = '';
                document.getElementById('resultProbability').textContent = '';
                document.getElementById('resultMessage').textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra l·∫°i.';
                updateStats();
                if (recognizeBtn) {
                    recognizeBtn.disabled = false;
                    recognizeBtn.textContent = 'Nh·∫≠n Di·ªán';
                }
            });
        }

        function controlDoor(command, triggerBtn = null) {
            if (triggerBtn) {
                triggerBtn.disabled = true;
                triggerBtn.textContent = 'ƒêang g·ª≠i...';
            }
            fetch(`${API_BASE}/test_mqtt?cmd=${command}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        log(`ƒê√£ g·ª≠i l·ªánh ${command} ƒë·∫øn ESP32`, 'success');
                        updateDoorStatus(command === 'OPEN' ? 'M·ªü' : 'ƒê√≥ng');
                    } else {
                        log(`L·ªói: ${data.message}`, 'error');
                    }
                    if (triggerBtn) {
                        triggerBtn.disabled = false;
                        triggerBtn.textContent = command === 'OPEN' ? 'M·ªü C·ª≠a' : 'ƒê√≥ng C·ª≠a';
                    }
                })
                .catch(error => {
                    log(`L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
                    if (triggerBtn) {
                        triggerBtn.disabled = false;
                        triggerBtn.textContent = command === 'OPEN' ? 'M·ªü C·ª≠a' : 'ƒê√≥ng C·ª≠a';
                    }
                });
        }

        function updateDoorStatus(status) {
            const doorStatusEl = document.getElementById('doorStatus');
            if (doorStatusEl) {
                doorStatusEl.textContent = status;
            }
        }

        function updateStats() {
            const totalEl = document.getElementById('totalRecognitions');
            const successEl = document.getElementById('successCount');
            const failEl = document.getElementById('failCount');
            if (!totalEl || !successEl || !failEl) return;
            totalEl.textContent = stats.total;
            successEl.textContent = stats.success;
            failEl.textContent = stats.fail;
        }

        function clearResult() {
            const resultBox = document.getElementById('resultBox');
            if (resultBox) {
                resultBox.style.display = 'none';
            }
            capturedImage = null;
            if (recognizeBtn) {
                recognizeBtn.disabled = true;
            }
            updateSaveButtonState();
            log('ƒê√£ x√≥a k·∫øt qu·∫£', 'info');
        }

        function sanitizePersonName(value) {
            if (!value) return '';
            return value.trim().toLowerCase()
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
        }

        function updateSaveButtonState() {
            if (!personNameInput || !saveToDatasetBtn) return;
            const name = sanitizePersonName(personNameInput.value);
            const hasImage = !!capturedImage;
            saveToDatasetBtn.disabled = !(name && hasImage);
            if (trainPersonBtn) {
                trainPersonBtn.disabled = !name;
            }
            if (alignPersonBtn) {
                alignPersonBtn.disabled = !name;
            }
        }

        function saveToDataset() {
            const name = sanitizePersonName(personNameInput.value);
            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi h·ª£p l·ªá!');
                return;
            }
            if (!capturedImage) {
                alert('C·∫ßn ch·ª•p ho·∫∑c ch·ªçn ·∫£nh tr∆∞·ªõc khi l∆∞u!');
                return;
            }
            if (saveToDatasetBtn) {
                saveToDatasetBtn.disabled = true;
                saveToDatasetBtn.textContent = 'ƒêang l∆∞u...';
            }
            log(`ƒêang l∆∞u ·∫£nh v√†o dataset cho ${name}...`, 'info');
            uploadBlobToDataset(capturedImage, name)
            .then(({status, body}) => {
                if (status === 200 && body.status === 'success') {
                    log(`ƒê√£ l∆∞u ·∫£nh m·ªõi v√†o ${body.person} (t·ªïng ${body.raw_count} ·∫£nh)`, 'success');
                    loadPersons();
                } else {
                    log(`L·ªói l∆∞u ·∫£nh: ${body.error || 'Kh√¥ng r√µ nguy√™n nh√¢n'}`, 'error');
                    alert(body.error || 'Kh√¥ng th·ªÉ l∆∞u ·∫£nh');
                }
            })
            .catch(error => {
                log(`L·ªói: ${error.message}`, 'error');
            })
            .finally(() => {
                if (saveToDatasetBtn) {
                    saveToDatasetBtn.disabled = false;
                    saveToDatasetBtn.textContent = 'L∆∞u ·∫¢nh V√†o Dataset';
                }
            });
        }

        function uploadBlobToDataset(blob, name) {
            const formData = new FormData();
            formData.append('name', name);
            formData.append('file', blob);
            return fetch(`${API_BASE}/api/save_capture`, {
                method: 'POST',
                body: formData
            }).then(response => response.json().then(data => ({status: response.status, body: data})));
        }

        function trainPerson() {
            const name = sanitizePersonName(personNameInput.value);
            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi h·ª£p l·ªá!');
                return;
            }
            const confirmTrain = confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën train l·∫°i model v·ªõi ng∆∞·ªùi "${name}"?\nQu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t.`);
            if (!confirmTrain) return;
            if (trainPersonBtn) {
                trainPersonBtn.disabled = true;
                trainPersonBtn.textContent = 'ƒêang train...';
            }
            log(`B·∫Øt ƒë·∫ßu train cho ${name}...`, 'info');
            fetch(`${API_BASE}/api/train_person`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name })
            })
            .then(response => response.json().then(data => ({status: response.status, body: data})))
            .then(({status, body}) => {
                if (status === 200 && body.success) {
                    log(`Train th√†nh c√¥ng cho ${name}!`, 'success');
                    alert('Train th√†nh c√¥ng! Restart server n·∫øu c·∫ßn ƒë·ªÉ load model m·ªõi.');
                } else {
                    log(`Train th·∫•t b·∫°i: ${body.error || body.message || 'Kh√¥ng r√µ l·ªói'}`, 'error');
                    alert(body.error || body.message || 'Train th·∫•t b·∫°i');
                }
            })
            .catch(error => {
                log(`L·ªói train: ${error.message}`, 'error');
            })
            .finally(() => {
                if (trainPersonBtn) {
                    trainPersonBtn.disabled = false;
                    trainPersonBtn.textContent = 'Train Ng∆∞·ªùi N√†y';
                }
            });
        }

        function alignPerson() {
            const name = sanitizePersonName(personNameInput.value);
            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi h·ª£p l·ªá!');
                return;
            }
            if (alignPersonBtn) {
                alignPersonBtn.disabled = true;
                alignPersonBtn.textContent = 'ƒêang align...';
            }
            log(`B·∫Øt ƒë·∫ßu align ·∫£nh cho ${name}...`, 'info');
            fetch(`${API_BASE}/api/align_person`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name })
            })
            .then(response => response.json().then(data => ({status: response.status, body: data})))
            .then(({status, body}) => {
                if (status === 200 && body.success) {
                    log(`Align th√†nh c√¥ng cho ${name}!`, 'success');
                    alert('Align th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ train ngay.');
                    loadPersons();
                } else {
                    log(`Align th·∫•t b·∫°i: ${body.error || body.message || 'Kh√¥ng r√µ l·ªói'}`, 'error');
                    alert(body.error || body.message || 'Align th·∫•t b·∫°i');
                }
            })
            .catch(error => {
                log(`L·ªói align: ${error.message}`, 'error');
            })
            .finally(() => {
                if (alignPersonBtn) {
                    alignPersonBtn.disabled = false;
                    alignPersonBtn.textContent = 'Align ·∫£nh';
                }
            });
        }

        async function startAutoCapture() {
            if (!autoCaptureBtn || !autoCaptureInput || !autoCaptureStatus || !personNameInput) {
                return;
            }
            if (autoCaptureState.running) {
                return;
            }
            const name = sanitizePersonName(personNameInput.value);
            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi (kh√¥ng d·∫•u) tr∆∞·ªõc!');
                return;
            }
            if (!stream) {
                alert('Vui l√≤ng b·∫≠t camera tr∆∞·ªõc khi ch·ª•p t·ª± ƒë·ªông!');
                return;
            }
            const target = Math.min(Math.max(parseInt(autoCaptureInput.value, 10) || 100, 10), 500);
            autoCaptureState = { running: true, target, count: 0, name };
            log(`B·∫Øt ƒë·∫ßu ch·ª•p t·ª± ƒë·ªông ${target} ·∫£nh cho ${name}...`, 'info');
            updateAutoCaptureUI();
            while (autoCaptureState.running && autoCaptureState.count < autoCaptureState.target) {
                try {
                    const blob = await captureFrameBlob();
                    const {status, body} = await uploadBlobToDataset(blob, name);
                    if (status === 200 && body.status === 'success') {
                        autoCaptureState.count += 1;
                        autoCaptureStatus.textContent = `ƒê√£ l∆∞u ${autoCaptureState.count}/${autoCaptureState.target} ·∫£nh cho ${name}`;
                        log(`ƒê√£ l∆∞u ·∫£nh ${autoCaptureState.count}/${autoCaptureState.target}`, 'success');
                        loadPersons();
                    } else {
                        throw new Error(body.error || 'Kh√¥ng th·ªÉ l∆∞u ·∫£nh');
                    }
                } catch (error) {
                    log(`L·ªói khi ch·ª•p t·ª± ƒë·ªông: ${error.message}`, 'error');
                    break;
                }
                await sleep(600);
            }
            if (autoCaptureState.count >= autoCaptureState.target) {
                log(`Ho√†n t·∫•t ch·ª•p ${autoCaptureState.target} ·∫£nh cho ${name}`, 'success');
            } else if (autoCaptureState.running) {
                log('D·ª´ng ch·ª•p do l·ªói.', 'error');
            }
            autoCaptureState.running = false;
            updateAutoCaptureUI();
        }

        function stopAutoCapture() {
            if (autoCaptureState.running) {
                autoCaptureState.running = false;
                log('ƒê√£ y√™u c·∫ßu d·ª´ng ch·ª•p t·ª± ƒë·ªông', 'info');
            }
        }

        function updateAutoCaptureUI() {
            if (!autoCaptureBtn || !stopAutoCaptureBtn || !autoCaptureStatus) {
                return;
            }
            if (autoCaptureState.running) {
                autoCaptureBtn.disabled = true;
                stopAutoCaptureBtn.disabled = false;
                autoCaptureStatus.textContent = `ƒêang ch·ª•p... ${autoCaptureState.count}/${autoCaptureState.target}`;
            } else {
                autoCaptureBtn.disabled = false;
                stopAutoCaptureBtn.disabled = true;
                autoCaptureStatus.textContent = autoCaptureState.count > 0
                    ? `ƒê√£ l∆∞u ${autoCaptureState.count} ·∫£nh g·∫ßn nh·∫•t.`
                    : 'Ch∆∞a b·∫Øt ƒë·∫ßu ch·ª•p t·ª± ƒë·ªông.';
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function loadPersons() {
            if (!personListEl) return;
            fetch(`${API_BASE}/api/persons`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.persons) {
                        renderPersonList(data.persons);
                    }
                })
                .catch(() => {
                    renderPersonList([]);
                });
        }

        function renderPersonList(persons) {
            if (!personListEl) return;
            if (!persons || persons.length === 0) {
                personListEl.innerHTML = '<li>Ch∆∞a c√≥ ng∆∞·ªùi n√†o trong dataset</li>';
                return;
            }
            personListEl.innerHTML = '';
            persons.forEach(person => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${person.name}</span><span class="person-count">${person.raw_count} raw / ${person.processed_count} proc</span>`;
                li.addEventListener('click', () => {
                    personNameInput.value = person.name;
                    updateSaveButtonState();
                    log(`ƒê√£ ch·ªçn ${person.name}`, 'info');
                });
                personListEl.appendChild(li);
            });
        }
    </script>
</body>
</html>

